# SpacetimeDB Multiplayer Demo

## Overview

This project demonstrates real-time multiplayer synchronization using [SpacetimeDB](https://spacetimedb.com/) (v1.1.1) as the backend and a web client built with React, TypeScript, and [React Three Fiber](https://docs.pmnd.rs/react-three-fiber/).

## Current State

- **SpacetimeDB Server (`/server`)**:
  - Written in Rust using SpacetimeDB modules.
  - Defines an `Entity` table (`id: u32`, `x: f64`, `y: f64`, `z: f64`).
  - `id` is manually generated by querying the max existing ID + 1 to ensure persistence across server restarts. The `#[auto_inc]` attribute caused issues during publishing when used on the primary key in this version.
  - Exposes a `spawn(x, y, z)` reducer to create new entities at specified coordinates.
  - Uses `log` crate for server-side logging.

- **Client (`/client`)**:
  - Built with React, TypeScript, and Vite.
  - Uses `@react-three/fiber` and `@react-three/drei` for 3D rendering.
  - Connects to the SpacetimeDB backend using generated client code (`/client/src/generated`).
  - Displays entities from the `Entity` table as red spheres.
  - Includes a button to call the `spawn` reducer, creating entities at random X/Z coordinates.
  - Uses `@clockworklabs/spacetimedb-sdk` (v1.1.0).

- **Development Environment**:
  - Includes VS Code tasks (`.vscode/tasks.json`) for common client/server actions.
  - `.gitignore` is configured for Rust and Node projects.
  - SpacetimeDB CLI installed via script to `~/.local/bin/spacetime`.

## Goals

- **Short-term**:
  - Implement entity movement controlled by the client.
  - Refine visual representation of entities.
- **Long-term**:
  - Add more complex interactions (deletion, modification).
  - Implement authentication and player representation.
  - Explore deployment options (e.g., SpacetimeDB Cloud).

## Getting Started

**Prerequisites:**

- Rust toolchain (`rustup`, `cargo`).
- Node.js and npm.
- SpacetimeDB CLI (v1.1.1). If not installed, run:
  ```sh
  curl -sSf https://install.spacetimedb.com | sh
  ```
  *Note: The CLI installs to `~/.local/bin/spacetime` by default.*

**Setup & Run Sequence:**

1.  **Install Dependencies:**
    ```sh
    # Server (Rust)
    cd server
    cargo build
    cd ..

    # Client (Node)
    cd client
    npm install
    cd ..
    ```

2.  **Start SpacetimeDB Server (Manual Recommended):**
    *   **IMPORTANT:** Running `spacetime start` via VS Code tasks can be unreliable (see Known Issues). It's recommended to run it manually in a dedicated terminal.
    *   If running from an AppImage environment (like Cursor), you **must** unset the `APPIMAGE` environment variable first.
    ```sh
    # In a separate terminal:
    unset APPIMAGE && /home/ksollner/.local/bin/spacetime start
    ```
    *(Leave this terminal running)*

3.  **Publish Server Module:**
    *   This needs to be done while the server from Step 2 is running.
    ```sh
    # If using AppImage:
    unset APPIMAGE && /home/ksollner/.local/bin/spacetime publish --project-path ./server spacetime

    # If not using AppImage (standard terminal):
    # /home/ksollner/.local/bin/spacetime publish --project-path ./server spacetime
    ```

4.  **Generate Client Code:**
    *   This requires the server module to be published (Step 3).
    ```sh
    # Run from the server directory
    cd server
    # If using AppImage:
    unset APPIMAGE && /home/ksollner/.local/bin/spacetime generate --lang typescript --out-dir ../client/src/generated
    # If not using AppImage:
    # /home/ksollner/.local/bin/spacetime generate --lang typescript --out-dir ../client/src/generated
    cd ..
    ```

5.  **Run Client Dev Server:**
    ```sh
    cd client
    npm run dev
    ```
    *   Open the URL provided by Vite (usually `http://localhost:5173`) in your browser.

## VS Code Tasks (`.vscode/tasks.json`)

Tasks are provided for convenience but have limitations (see Known Issues).

-   `Client: dev`: Runs `npm run dev` in `/client`.
-   `Client: build`: Runs `npm run build` in `/client`.
-   `Server: start`: Attempts to run `spacetime start`. **(Currently unreliable, use manual start)**.
-   `Server: publish`: Attempts to publish the module. **(Requires manual server start)**.

*Note: Server tasks use the absolute path `/home/ksollner/.local/bin/spacetime` and include the `unset APPIMAGE` workaround.*

## Known Issues / Workarounds

1.  **`spacetime start` via VS Code Tasks:** Running the "Server: start" task often fails silently (`exit code 1`) even with correct paths and workarounds.
    *   **Workaround:** Run `unset ARGV0 && unset APPIMAGE && /home/ksollner/.local/bin/spacetime start` manually in a separate terminal.
2.  **AppImage Environment Conflict (`APPIMAGE`, `ARGV0`):** When running VS Code/Cursor as an AppImage, environment variables set by the AppImage interfere with the `spacetime` CLI and `cargo` (via `rustup` proxy).
    *   `APPIMAGE`: Causes `spacetime` internal command dispatching issues ("multicall binary" error).
    *   `ARGV0`: Causes `cargo build` (and potentially other `rustup` tools) to fail with an "unknown proxy name" error.
    *   **Workaround:** Prefix all relevant commands (`cargo build`, `spacetime start`, `spacetime publish`, `spacetime generate`) with `unset ARGV0 && unset APPIMAGE && ` when running them from within the AppImage environment. The provided tasks in `.vscode/tasks.json` already include this combined workaround.
3.  **Client SDK Typing:** Using the `@clockworklabs/spacetimedb-sdk` directly without generated code is difficult due to complex types and builder patterns.
    *   **Solution:** Always run `spacetime generate` after publishing the module and use the generated types/classes from `/client/src/generated`.
4.  **Entity ID Generation:** Using `#[auto_inc]` on the primary key caused internal SpacetimeDB errors during `publish`.
    *   **Solution:** The server now uses manual ID generation by querying the max existing ID + 1.

## Contributing

Pull requests and issues are welcome!